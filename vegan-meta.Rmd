---
title: "Vegan meta-analysis "
author: "Seth Green & Benny Smith"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  word_document: default
editor_options:
  chunk_output_type: console
---

**libraries, functions, options, and data**

```{r setup, message=F}
#' libraries
library(metafor, quietly = T)
library(dplyr, warn.conflicts = F)
library(ggforestplot) # https://nightingalehealth.github.io/ggforestplot
library(ggplot2, warn.conflicts = F)
library(knitr)
library(purrr)
library(sessioninfo)
library(stringr)

#' functions
source('./functions/d_calc.R')
source('./functions/map_robust.R')
source('./functions/sum_lm.R')
source('./functions/sum_tab.R')
source('./functions/var_d_calc.R')

#' options and reproducibility
options(scipen = 99)
set.seed(11111988)

```

**load data, add more descriptive vars, and add d, var_d, and se_d**

```{r load_data}

dat <- read.csv('./data/vegan-meta.csv')  |>
  group_by(title) |>
  mutate(unique_paper_id = cur_group_id())  |> # create unique paper id
  group_by(unique_paper_id, intervention_condition) |> 
  mutate(unique_study_id = cur_group_id()) |> ### create unique study id
  ungroup() |>
  mutate(
         decade = as.factor(
      case_when(
        year >= 2000 & year <= 2009 ~ "2000s",
        year >= 2010 & year <= 2019  ~ "2010s",
        year >= 2020 ~ "2020s")),
      d = mapply(
        FUN = d_calc,
        stat_type = eff_type,
        stat =  u_s_d,
        sample_sd = ctrl_sd,
        n_t = n_t_post,
        n_c = n_c_post),
      var_d = mapply(
        FUN = var_d_calc,
        d = d,
        n_c = n_c_post,
        n_t = n_t_post),
      se_d = sqrt(var_d))

```

### 3.3 descriptive stats
mean N, country table, and population

```{r descriptive_stats}
dat |> group_by(cluster_assigned) |> 
  summarise(pop_total = round(mean(n_c_post) + mean(n_t_post)),
            median_pop = round(median(n_c_post) + median(n_t_post)))
            
sort(table(dat$country))
table(dat$population)
```

# Meta-analysis

### 4.1 Overall effect

```{r avg_eff}
dat |> map_robust()
```

Sign test (how many studies were positive, negative, or neutral in their authors' own words)

```{r sign_test}
sign_table <- table(dat$neg_null_pos)
binom.test(sign_table[[3]], sum(sign_table[1:3]))
```

Fig 1: forest plot

```{r forest_plot}
dat |> 
  mutate(study_name = paste0(author, " ", year)) |> 
           arrange(var_d) |> ggforestplot::forestplot(study_name,
                         estimate = d, se = se_d, 
                         colour = theory, 
                         xlab = expression(paste("Glass's", " ", Delta)), 
                         ylab = "Study",
                         title = "Vegan meta Forest Plot") +
    geom_vline(xintercept = (dat |> map_robust())$beta, 
                            lty = 'dashed') +  # color = '#00BFC4'
  theme(plot.title = element_text(hjust = 0.5))
```


### 4.2 publication bias
```{r pub_bias}
dat |> sum_lm()

dat |> ggplot(aes(d, se_d)) + 
  geom_point(aes(color = theory)) + 
  stat_smooth(method = 'lm', se = F, color = 'grey', 
              lty = 'dashed', linewidth = 1) + 
  theme_minimal() +
  ggtitle('relationship between effect size and standard erors')

#' split by published/unpublished (DOI = published)

dat |> split(~str_detect(dat$doi_or_url, "10\\.")) |> 
  map(sum_lm) 

dat |> split(~str_detect(dat$doi_or_url, "10\\.")) |> 
  imap(~map_robust(.x) |> kable('markdown')) 
```

### 4.3 differences by clustering, theory, persuasion theory, and self-report? 

```{r cluster}

dat |> split(~cluster_assigned) |> imap(~map_robust(.x) |> kable('markdown'))

dat |> filter(theory != 'economics') |> 
  # economics has one study so we have to report it separately
  split(~theory) |> 
  imap(~map_robust(.x) |> kable('markdown'))

dat |> filter(theory == 'economics') |> select(author, year, d, se_d)

dat |> split(~self_report) |> imap(~map_robust(.x) |> kable('markdown'))

# dat |> filter(theory == 'persuasion') |> 
#   split(~persuasion_category) |> 
#   imap(~map_robust(.x) |> 
#          kable('markdown'))

# a couple zoom ins on the self-report vs not

dat |>
  split(~self_report) |>
  imap(~ sum_tab(.x, theory))

dat |>
  split(~self_report) |>
  imap(~ sum_tab(.x, decade))
#' I'm expecting to see here that non-self-reported things basically start
#' in the past 3-5 years and that some theories are just plum missing
```

### 4.4 Social desirability penalty
Mathur et al. (2021b) provide a nice estimate of the magnitude of social desirability bias in self-reported outcome research of about $\beta$ = 0.1. What if we discount all self-reported outcomes bhy about that much, what do the overall effects look like?

```{r social_desirability_penalty}
## totally have to rework this
```

### 4.5 do leaflet studies work? 

```{r leaflet}

dat|>
  filter(str_detect(intervention_condition, "leaflet") |
           str_detect(brief_description, "leaflet")) |>
  map_robust()
```

### 4.6 How do studies administered online compare to in-person studies?

```{r online_vs_in_person}
# effect size comparison
dat |> split(~str_detect(country, "internet")) |> map(map_robust)

# simple null vs not comparison (not simple to code, thank you chatGPT)
dat |>
  mutate(country_group = ifelse(grepl("internet", country), "Internet", "Other"))|>
  group_by(country_group)|>
  do({
    test_result <- binom.test(sum(.$neg_null_pos == 1), length(.$neg_null_pos), conf.level = 0.95)
    tibble(
      estimate = test_result$estimate,
      conf_low = test_result$conf.int[1],
      conf_high = test_result$conf.int[2],
      p_value = round(test_result$p.value, 5)
    )
  })
```

### 4.7 Any relationship between delay and outcome?

```{r delay}
dat |> sum_lm(d, delay)
dat |> ggplot(aes(d, delay)) + geom_point() + 
  stat_smooth(method = 'lm', se = F) + theme_minimal()
```

### 4.8 any relationship between publication date and effect size or validity?

```{r publication_date}

dat |> sum_lm(d, year) #...what is happening with year and d in this dataset

dat |> split(~decade) |>  
  map(map_robust)
# wow! This is one of the most interesting results

dat |> ggplot(aes(year, d)) + geom_point() + 
  stat_smooth(method = 'lm', se = F) + theme_minimal()
```

### 4.9 record computational environment
```{r reproducibility}
session_info()
```